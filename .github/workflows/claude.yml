name: Claude Code

on:
  # PRåˆ›å»ºå’Œæ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘
  pull_request:
    types: [opened, synchronize]
  # æ‰‹åŠ¨è§¦å‘(@claude)
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # éœ€è¦è¯»å†™æƒé™æ¥è¯»å–PRè¯„è®ºå’Œåˆ›å»ºè¯„è®º
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„gitå†å²ä»¥æ”¯æŒå¢é‡åˆ†æ

      # æ£€æµ‹å®¡è®¡ç±»å‹ï¼šé¦–æ¬¡å®¡è®¡ vs å¢é‡å®¡è®¡
      - name: Detect audit type and get commit range
        id: audit-info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "opened" ]; then
            echo "audit_type=initial" >> $GITHUB_OUTPUT
            echo "commit_range=full" >> $GITHUB_OUTPUT
            echo "ğŸš€ é¦–æ¬¡PRå®¡è®¡ - å®¡è®¡æ‰€æœ‰å˜æ›´"
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "synchronize" ]; then
            echo "audit_type=incremental" >> $GITHUB_OUTPUT
            echo "commit_range=recent" >> $GITHUB_OUTPUT
            echo "ğŸ”„ PRæ›´æ–°å®¡è®¡ - å®¡è®¡æœ€æ–°å˜æ›´"
          else
            # æŸ¥æ‰¾ä¸Šä¸€æ¬¡Claudeè¯„è®ºçš„æ—¶é—´
            PR_NUMBER=${{ github.event.pull_request.number || github.event.issue.number }}
            LAST_CLAUDE_COMMENT=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.author.login == "github-actions[bot]" or .body | contains("Claude Code")) | .createdAt' | tail -1)

            if [ -z "$LAST_CLAUDE_COMMENT" ]; then
              echo "audit_type=initial" >> $GITHUB_OUTPUT
              echo "commit_range=full" >> $GITHUB_OUTPUT
              echo "ğŸš€ é¦–æ¬¡å®¡è®¡ - æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„Claudeè¯„è®º"
            else
              echo "audit_type=incremental" >> $GITHUB_OUTPUT
              # è·å–ä¸Šæ¬¡å®¡è®¡åçš„commits
              COMMITS_SINCE=$(git log --since="$LAST_CLAUDE_COMMENT" --pretty=format:"%H" | tr '\n' ' ')
              echo "commit_range=$COMMITS_SINCE" >> $GITHUB_OUTPUT
              echo "ğŸ”„ å¢é‡å®¡è®¡ - å®¡è®¡è‡ª $LAST_CLAUDE_COMMENT ä»¥æ¥çš„æäº¤: $COMMITS_SINCE"
            fi
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4.1)
          # model: "claude-opus-4-1-20250805"

          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"

          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"

          # Optional: Allow Claude to run specific commands
          # allowed_tools: "Bash(npm install),Bash(npm run build),Bash(npm run test:*),Bash(npm run lint:*)"

          # Custom instructions for Claude to customize its behavior for your project
          custom_instructions: |
            ä½ æ˜¯CyberEdgeç½‘ç»œå®‰å…¨æ¸—é€æµ‹è¯•å¹³å°çš„ä¸“ä¸šä»£ç åŠ©æ‰‹ã€‚

            ## å®¡è®¡ç±»å‹: ${{ steps.audit-info.outputs.audit_type }}

            ${{ steps.audit-info.outputs.audit_type == 'initial' && '
            ğŸš€ **é¦–æ¬¡PRå®¡è®¡** - è¯·å…¨é¢å®¡æŸ¥æœ¬PRä¸­çš„æ‰€æœ‰å˜æ›´ï¼š
            - å®¡æŸ¥æ‰€æœ‰æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤çš„æ–‡ä»¶
            - é‡ç‚¹å…³æ³¨ä»£ç è´¨é‡ã€å®‰å…¨æ€§ã€æ€§èƒ½
            - æ£€æŸ¥æ˜¯å¦éµå¾ªé¡¹ç›®ç¼–ç æ ‡å‡†
            - ç¡®ä¿æ–°åŠŸèƒ½æœ‰å¯¹åº”çš„æµ‹è¯•
            ' || '
            ğŸ”„ **å¢é‡å®¡è®¡** - è¯·é‡ç‚¹å®¡æŸ¥æœ€è¿‘çš„å˜æ›´ï¼š
            - ä¸»è¦å…³æ³¨è‡ªä¸Šæ¬¡å®¡è®¡ä»¥æ¥çš„æ–°commit
            - æ¯”è¾ƒä¸ä¹‹å‰å®¡è®¡ç‰ˆæœ¬çš„å·®å¼‚
            - é‡ç‚¹å…³æ³¨æ–°å¼•å…¥çš„å®‰å…¨é£é™©å’Œä»£ç è´¨é‡é—®é¢˜
            - å¦‚æœå‘ç°æ”¹è¿›ç‚¹ï¼Œæä¾›å…·ä½“çš„ä¿®æ”¹å»ºè®®
            ' }}

            ## é€šç”¨å®¡è®¡è¦æ±‚ï¼š
            - å§‹ç»ˆç”¨ä¸­æ–‡å›å¤
            - éµå¾ªé¡¹ç›®çš„ç¼–ç æ ‡å‡†
            - ç¡®ä¿æ‰€æœ‰æ–°ä»£ç éƒ½æœ‰ç›¸åº”çš„æµ‹è¯•
            - å¯¹äºåç«¯Goä»£ç ï¼Œæ³¨é‡æ€§èƒ½å’Œå®‰å…¨æ€§
            - å¯¹äºå‰ç«¯Vue.jsä»£ç ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒå’Œå¯ç»´æŠ¤æ€§
            - ç‰¹åˆ«å…³æ³¨å®‰å…¨æ¼æ´å’Œæ½œåœ¨çš„å®‰å…¨é£é™©
            - å¯¹æ¸—é€æµ‹è¯•å·¥å…·çš„é›†æˆç»™å‡ºä¸“ä¸šå»ºè®®
            - æä¾›å…·ä½“ã€å¯æ‰§è¡Œçš„æ”¹è¿›å»ºè®®

            ${{ steps.audit-info.outputs.commit_range != 'full' && format('
            ## å¢é‡å®¡è®¡èŒƒå›´ï¼š
            æœ¬æ¬¡å®¡è®¡çš„commitèŒƒå›´: {0}
            è¯·ä½¿ç”¨ `git show` æˆ– `git diff` å‘½ä»¤æŸ¥çœ‹è¿™äº›ç‰¹å®šcommitçš„å˜æ›´å†…å®¹ã€‚
            ', steps.audit-info.outputs.commit_range) || '' }}

          # Custom environment variables for Claude
          claude_env: |
            AUDIT_TYPE: ${{ steps.audit-info.outputs.audit_type }}
            COMMIT_RANGE: ${{ steps.audit-info.outputs.commit_range }}
            PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

