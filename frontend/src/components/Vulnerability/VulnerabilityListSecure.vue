<template>
  <div class="vulnerability-list">
    <div class="list-header">
      <h3>漏洞管理</h3>
      <div class="filters">
        <select v-model="filters.severity" @change="applyFilters">
          <option value="">所有严重程度</option>
          <option value="critical">严重</option>
          <option value="high">高危</option>
          <option value="medium">中危</option>
          <option value="low">低危</option>
          <option value="info">信息</option>
        </select>

        <select v-model="filters.status" @change="applyFilters">
          <option value="">所有状态</option>
          <option value="open">未修复</option>
          <option value="fixed">已修复</option>
          <option value="false_positive">误报</option>
        </select>

        <input
          type="text"
          v-model="filters.search"
          @input="debounceSearch"
          :maxlength="100"
          placeholder="搜索漏洞..."
          class="search-input"
        />
      </div>
    </div>

    <div v-if="loading" class="loading">
      <div class="spinner"></div>
      <p>加载中...</p>
    </div>

    <div v-else-if="error" class="error-message">
      <p>{{ error }}</p>
      <button @click="loadVulnerabilities" class="retry-btn">重试</button>
    </div>

    <div v-else-if="vulnerabilities.length === 0" class="no-data">
      <p>暂无漏洞数据</p>
    </div>

    <div v-else class="vulnerability-table-container">
      <table class="vulnerability-table">
        <thead>
          <tr>
            <th>漏洞信息</th>
            <th>严重程度</th>
            <th>CVSS分数</th>
            <th>位置</th>
            <th>状态</th>
            <th>发现时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="vuln in paginatedVulnerabilities" :key="vuln.id" class="vuln-row">
            <td>
              <div class="vuln-title">
                <!-- 使用v-text防止XSS，而不是双花括号插值 -->
                <span class="title" v-text="sanitizeText(vuln.title)"></span>
                <span v-if="vuln.cve_id" class="cve-id" v-text="sanitizeText(vuln.cve_id)"></span>
              </div>
              <!-- 安全地显示描述，限制长度 -->
              <div class="vuln-description" v-text="truncateText(sanitizeText(vuln.description), 100)"></div>
            </td>
            <td>
              <span class="severity-badge" :class="getSeverityClass(vuln.severity)">
                {{ getSeverityLabel(vuln.severity) }}
              </span>
            </td>
            <td>
              <span class="cvss-score" :class="getCvssClass(vuln.cvss)">
                {{ formatCvss(vuln.cvss) }}
              </span>
            </td>
            <td>
              <!-- 安全地显示位置信息 -->
              <span class="location" v-text="sanitizeText(vuln.location)"></span>
            </td>
            <td>
              <select
                :value="vuln.status"
                @change="updateVulnStatus(vuln.id, $event.target.value)"
                class="status-select"
              >
                <option value="open">未修复</option>
                <option value="fixed">已修复</option>
                <option value="false_positive">误报</option>
              </select>
            </td>
            <td>
              {{ formatDate(vuln.created_at) }}
            </td>
            <td>
              <div class="actions">
                <button @click="viewVulnDetail(vuln)" class="btn-detail">
                  详情
                </button>
                <button @click="exportVuln(vuln)" class="btn-export">
                  导出
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- 分页控件 -->
      <div class="pagination">
        <button
          @click="currentPage--"
          :disabled="currentPage === 1"
          class="page-btn"
        >
          上一页
        </button>

        <span class="page-info">
          第 {{ currentPage }} 页，共 {{ totalPages }} 页 ({{ filteredVulnerabilities.length }} 条记录)
        </span>

        <button
          @click="currentPage++"
          :disabled="currentPage === totalPages"
          class="page-btn"
        >
          下一页
        </button>
      </div>
    </div>

    <!-- 漏洞详情模态框 -->
    <div v-if="selectedVuln" class="modal-overlay" @click="closeModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h4>漏洞详情</h4>
          <button @click="closeModal" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="detail-section">
            <label>标题:</label>
            <!-- 安全显示漏洞详情 -->
            <p v-text="sanitizeText(selectedVuln.title)"></p>
          </div>
          <div class="detail-section">
            <label>CVE编号:</label>
            <p v-text="sanitizeText(selectedVuln.cve_id || '无')"></p>
          </div>
          <div class="detail-section">
            <label>描述:</label>
            <div class="description-box" v-text="sanitizeText(selectedVuln.description)"></div>
          </div>
          <div class="detail-section">
            <label>严重程度:</label>
            <span class="severity-badge" :class="getSeverityClass(selectedVuln.severity)">
              {{ getSeverityLabel(selectedVuln.severity) }}
            </span>
          </div>
          <div class="detail-section">
            <label>CVSS分数:</label>
            <span class="cvss-score" :class="getCvssClass(selectedVuln.cvss)">
              {{ formatCvss(selectedVuln.cvss) }}
            </span>
          </div>
          <div class="detail-section">
            <label>位置:</label>
            <p v-text="sanitizeText(selectedVuln.location)"></p>
          </div>
          <div v-if="selectedVuln.parameter" class="detail-section">
            <label>参数:</label>
            <p v-text="sanitizeText(selectedVuln.parameter)"></p>
          </div>
          <div v-if="selectedVuln.payload" class="detail-section">
            <label>载荷:</label>
            <pre class="payload-box" v-text="sanitizeText(selectedVuln.payload)"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, reactive, computed, onMounted, watch } from 'vue'
import { vulnerabilityAPI } from '@/services/api'
import { showToast } from '@/utils/toast'

export default {
  name: 'VulnerabilityListSecure',
  props: {
    projectId: {
      type: [String, Number],
      required: true
    }
  },
  setup(props) {
    const vulnerabilities = ref([])
    const loading = ref(false)
    const error = ref('')
    const selectedVuln = ref(null)
    const currentPage = ref(1)
    const pageSize = 20

    const filters = reactive({
      severity: '',
      status: '',
      search: ''
    })

    let searchTimeout = null

    // 文本安全化函数 - 防止XSS攻击
    const sanitizeText = (text) => {
      if (!text || typeof text !== 'string') return ''

      // 移除HTML标签和潜在的脚本内容
      return text
        .replace(/<[^>]*>/g, '') // 移除HTML标签
        .replace(/javascript:/gi, '') // 移除javascript:链接
        .replace(/on\w+=/gi, '') // 移除事件处理器
        .replace(/data:text\/html/gi, '') // 移除data URI
        .trim()
        .substring(0, 1000) // 限制长度防止DoS
    }

    // 文本截断函数
    const truncateText = (text, maxLength) => {
      if (!text) return ''
      if (text.length <= maxLength) return text
      return text.substring(0, maxLength) + '...'
    }

    // 获取严重程度样式类
    const getSeverityClass = (severity) => {
      const severityMap = {
        'critical': 'severity-critical',
        'high': 'severity-high',
        'medium': 'severity-medium',
        'low': 'severity-low',
        'info': 'severity-info'
      }
      return severityMap[severity] || 'severity-unknown'
    }

    // 获取严重程度标签
    const getSeverityLabel = (severity) => {
      const labels = {
        'critical': '严重',
        'high': '高危',
        'medium': '中危',
        'low': '低危',
        'info': '信息'
      }
      return labels[severity] || '未知'
    }

    // 获取CVSS分数样式类
    const getCvssClass = (cvss) => {
      if (cvss >= 9.0) return 'cvss-critical'
      if (cvss >= 7.0) return 'cvss-high'
      if (cvss >= 4.0) return 'cvss-medium'
      if (cvss > 0) return 'cvss-low'
      return 'cvss-none'
    }

    // 格式化CVSS分数
    const formatCvss = (cvss) => {
      if (!cvss || cvss === 0) return 'N/A'
      return Number(cvss).toFixed(1)
    }

    // 格式化日期
    const formatDate = (dateStr) => {
      if (!dateStr) return 'N/A'
      try {
        return new Date(dateStr).toLocaleDateString('zh-CN')
      } catch {
        return 'N/A'
      }
    }

    // 过滤后的漏洞列表
    const filteredVulnerabilities = computed(() => {
      return vulnerabilities.value.filter(vuln => {
        // 严重程度过滤
        if (filters.severity && vuln.severity !== filters.severity) {
          return false
        }

        // 状态过滤
        if (filters.status && vuln.status !== filters.status) {
          return false
        }

        // 搜索过滤 - 安全地进行搜索
        if (filters.search) {
          const searchTerm = sanitizeText(filters.search).toLowerCase()
          const title = sanitizeText(vuln.title).toLowerCase()
          const description = sanitizeText(vuln.description).toLowerCase()
          const cveId = sanitizeText(vuln.cve_id || '').toLowerCase()

          if (!title.includes(searchTerm) &&
              !description.includes(searchTerm) &&
              !cveId.includes(searchTerm)) {
            return false
          }
        }

        return true
      })
    })

    // 分页后的漏洞列表
    const paginatedVulnerabilities = computed(() => {
      const start = (currentPage.value - 1) * pageSize
      const end = start + pageSize
      return filteredVulnerabilities.value.slice(start, end)
    })

    // 总页数
    const totalPages = computed(() => {
      return Math.ceil(filteredVulnerabilities.value.length / pageSize)
    })

    // 加载漏洞数据
    const loadVulnerabilities = async () => {
      try {
        loading.value = true
        error.value = ''

        const response = await vulnerabilityAPI.getVulnerabilities(props.projectId, filters)

        if (response.success) {
          vulnerabilities.value = response.vulnerabilities || []
        } else {
          throw new Error(response.error || '加载失败')
        }
      } catch (err) {
        console.error('加载漏洞失败:', err)
        error.value = '加载漏洞数据失败，请重试'
        vulnerabilities.value = []
      } finally {
        loading.value = false
      }
    }

    // 防抖搜索
    const debounceSearch = () => {
      clearTimeout(searchTimeout)
      searchTimeout = setTimeout(() => {
        currentPage.value = 1 // 重置到第一页
        loadVulnerabilities()
      }, 500)
    }

    // 应用过滤器
    const applyFilters = () => {
      currentPage.value = 1
      loadVulnerabilities()
    }

    // 更新漏洞状态
    const updateVulnStatus = async (vulnId, newStatus) => {
      try {
        const response = await vulnerabilityAPI.updateStatus(vulnId, newStatus)

        if (response.success) {
          // 更新本地数据
          const vuln = vulnerabilities.value.find(v => v.id === vulnId)
          if (vuln) {
            vuln.status = newStatus
          }
          showToast('漏洞状态更新成功', 'success')
        } else {
          throw new Error(response.error || '更新失败')
        }
      } catch (err) {
        console.error('更新漏洞状态失败:', err)
        showToast('更新漏洞状态失败', 'error')
        // 重新加载以恢复原状态
        loadVulnerabilities()
      }
    }

    // 查看漏洞详情
    const viewVulnDetail = (vuln) => {
      selectedVuln.value = vuln
    }

    // 关闭模态框
    const closeModal = () => {
      selectedVuln.value = null
    }

    // 导出漏洞
    const exportVuln = (vuln) => {
      try {
        const data = {
          id: vuln.id,
          title: sanitizeText(vuln.title),
          cve_id: sanitizeText(vuln.cve_id),
          description: sanitizeText(vuln.description),
          severity: vuln.severity,
          cvss: vuln.cvss,
          location: sanitizeText(vuln.location),
          status: vuln.status,
          created_at: vuln.created_at
        }

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `vulnerability-${vuln.id}.json`
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)

        showToast('漏洞导出成功', 'success')
      } catch (err) {
        console.error('导出漏洞失败:', err)
        showToast('导出漏洞失败', 'error')
      }
    }

    // 监听项目ID变化
    watch(() => props.projectId, () => {
      if (props.projectId) {
        loadVulnerabilities()
      }
    })

    // 组件挂载时加载数据
    onMounted(() => {
      if (props.projectId) {
        loadVulnerabilities()
      }
    })

    return {
      vulnerabilities,
      loading,
      error,
      selectedVuln,
      currentPage,
      filters,
      filteredVulnerabilities,
      paginatedVulnerabilities,
      totalPages,
      sanitizeText,
      truncateText,
      getSeverityClass,
      getSeverityLabel,
      getCvssClass,
      formatCvss,
      formatDate,
      loadVulnerabilities,
      debounceSearch,
      applyFilters,
      updateVulnStatus,
      viewVulnDetail,
      closeModal,
      exportVuln
    }
  }
}
</script>

<style scoped>
.vulnerability-list {
  padding: 20px;
  background: #f5f5f5;
  min-height: 100vh;
}

.list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filters {
  display: flex;
  gap: 15px;
  align-items: center;
}

.filters select,
.search-input {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.search-input {
  width: 200px;
}

.loading {
  text-align: center;
  padding: 40px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-message {
  text-align: center;
  padding: 40px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  color: #e74c3c;
}

.retry-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 10px;
}

.no-data {
  text-align: center;
  padding: 40px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  color: #666;
}

.vulnerability-table-container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  overflow: hidden;
}

.vulnerability-table {
  width: 100%;
  border-collapse: collapse;
}

.vulnerability-table th,
.vulnerability-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

.vulnerability-table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #333;
}

.vuln-title {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.title {
  font-weight: 600;
  color: #333;
}

.cve-id {
  font-size: 12px;
  color: #666;
  background: #f0f0f0;
  padding: 2px 6px;
  border-radius: 3px;
  width: fit-content;
}

.vuln-description {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
  line-height: 1.4;
}

.severity-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.severity-critical {
  background: #e74c3c;
  color: white;
}

.severity-high {
  background: #e67e22;
  color: white;
}

.severity-medium {
  background: #f39c12;
  color: white;
}

.severity-low {
  background: #27ae60;
  color: white;
}

.severity-info {
  background: #3498db;
  color: white;
}

.severity-unknown {
  background: #95a5a6;
  color: white;
}

.cvss-score {
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 600;
  color: white;
}

.cvss-critical {
  background: #e74c3c;
}

.cvss-high {
  background: #e67e22;
}

.cvss-medium {
  background: #f39c12;
}

.cvss-low {
  background: #27ae60;
}

.cvss-none {
  background: #95a5a6;
}

.location {
  font-family: monospace;
  font-size: 12px;
  background: #f8f9fa;
  padding: 2px 4px;
  border-radius: 3px;
}

.status-select {
  padding: 4px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 12px;
}

.actions {
  display: flex;
  gap: 8px;
}

.btn-detail,
.btn-export {
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}

.btn-detail {
  background: #3498db;
  color: white;
}

.btn-export {
  background: #27ae60;
  color: white;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  padding: 20px;
  background: #f8f9fa;
}

.page-btn {
  padding: 8px 16px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 4px;
  cursor: pointer;
}

.page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.page-info {
  color: #666;
  font-size: 14px;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 8px;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  margin: 20px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #eee;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.modal-body {
  padding: 20px;
}

.detail-section {
  margin-bottom: 20px;
}

.detail-section label {
  display: block;
  font-weight: 600;
  margin-bottom: 5px;
  color: #333;
}

.description-box,
.payload-box {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 10px;
  max-height: 200px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-all;
}

.payload-box {
  font-family: monospace;
  font-size: 12px;
}
</style>