<template>
  <div class="vulnerability-list">
    <div class="page-header">
      <h1>æ¼æ´ç®¡ç†</h1>
      <div class="header-actions">
        <select v-model="selectedProject" @change="loadVulnerabilities" class="project-select">
          <option value="">é€‰æ‹©é¡¹ç›®</option>
          <option v-for="project in projects" :key="project.id" :value="project.id">
            {{ project.name }}
          </option>
        </select>
        <button @click="exportVulnerabilities" class="btn btn-secondary" :disabled="!selectedProject">
          <span class="icon">ğŸ“Š</span>
          å¯¼å‡ºæŠ¥å‘Š
        </button>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>ä¸¥é‡ç¨‹åº¦:</label>
        <div class="severity-filters">
          <label class="checkbox-label">
            <input type="checkbox" v-model="filters.severity" value="critical" @change="applyFilters">
            <span class="severity-badge critical">ä¸¥é‡</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" v-model="filters.severity" value="high" @change="applyFilters">
            <span class="severity-badge high">é«˜å±</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" v-model="filters.severity" value="medium" @change="applyFilters">
            <span class="severity-badge medium">ä¸­å±</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" v-model="filters.severity" value="low" @change="applyFilters">
            <span class="severity-badge low">ä½å±</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" v-model="filters.severity" value="info" @change="applyFilters">
            <span class="severity-badge info">ä¿¡æ¯</span>
          </label>
        </div>
      </div>

      <div class="filter-group">
        <label>çŠ¶æ€:</label>
        <select v-model="filters.status" @change="applyFilters" class="status-select">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="open">æœªä¿®å¤</option>
          <option value="fixed">å·²ä¿®å¤</option>
          <option value="false_positive">è¯¯æŠ¥</option>
        </select>
      </div>

      <div class="filter-group">
        <input
          v-model="filters.search"
          @input="applyFilters"
          placeholder="æœç´¢æ¼æ´..."
          class="search-input"
        />
      </div>
    </div>

    <div class="vulnerability-stats">
      <div class="stat-card critical">
        <div class="stat-count">{{ stats.critical || 0 }}</div>
        <div class="stat-label">ä¸¥é‡</div>
      </div>
      <div class="stat-card high">
        <div class="stat-count">{{ stats.high || 0 }}</div>
        <div class="stat-label">é«˜å±</div>
      </div>
      <div class="stat-card medium">
        <div class="stat-count">{{ stats.medium || 0 }}</div>
        <div class="stat-label">ä¸­å±</div>
      </div>
      <div class="stat-card low">
        <div class="stat-count">{{ stats.low || 0 }}</div>
        <div class="stat-label">ä½å±</div>
      </div>
      <div class="stat-card info">
        <div class="stat-count">{{ stats.info || 0 }}</div>
        <div class="stat-label">ä¿¡æ¯</div>
      </div>
    </div>

    <div v-if="loading" class="loading">
      <div class="spinner"></div>
      <p>åŠ è½½ä¸­...</p>
    </div>

    <div v-else-if="vulnerabilities.length > 0" class="vulnerability-table">
      <table>
        <thead>
          <tr>
            <th>æ¼æ´æ ‡é¢˜</th>
            <th>ä¸¥é‡ç¨‹åº¦</th>
            <th>CVSSåˆ†æ•°</th>
            <th>ä½ç½®</th>
            <th>çŠ¶æ€</th>
            <th>å‘ç°æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="vuln in paginatedVulnerabilities" :key="vuln.id" class="vuln-row">
            <td>
              <div class="vuln-title">
                <span class="title">{{ vuln.title }}</span>
                <span v-if="vuln.cve_id" class="cve-id">{{ vuln.cve_id }}</span>
              </div>
            </td>
            <td>
              <span class="severity-badge" :class="vuln.severity">
                {{ getSeverityLabel(vuln.severity) }}
              </span>
            </td>
            <td>
              <span class="cvss-score" :class="getCvssClass(vuln.cvss)">
                {{ vuln.cvss || 'N/A' }}
              </span>
            </td>
            <td>
              <div class="location">
                <span class="location-text">{{ vuln.location }}</span>
                <span v-if="vuln.parameter" class="parameter">{{ vuln.parameter }}</span>
              </div>
            </td>
            <td>
              <select
                v-model="vuln.status"
                @change="updateVulnStatus(vuln)"
                class="status-select inline"
                :class="vuln.status"
              >
                <option value="open">æœªä¿®å¤</option>
                <option value="fixed">å·²ä¿®å¤</option>
                <option value="false_positive">è¯¯æŠ¥</option>
              </select>
            </td>
            <td>
              <span class="date">{{ formatDate(vuln.created_at) }}</span>
            </td>
            <td>
              <div class="actions">
                <button @click="viewVulnerability(vuln)" class="btn-icon" title="æŸ¥çœ‹è¯¦æƒ…">
                  <span class="icon">ğŸ‘ï¸</span>
                </button>
                <button @click="copyLocation(vuln)" class="btn-icon" title="å¤åˆ¶ä½ç½®">
                  <span class="icon">ğŸ“‹</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="pagination">
        <button
          @click="prevPage"
          :disabled="currentPage === 1"
          class="btn btn-secondary"
        >
          ä¸Šä¸€é¡µ
        </button>
        <span class="page-info">
          ç¬¬ {{ currentPage }} é¡µï¼Œå…± {{ totalPages }} é¡µ
          ({{ filteredVulnerabilities.length }} ä¸ªæ¼æ´)
        </span>
        <button
          @click="nextPage"
          :disabled="currentPage === totalPages"
          class="btn btn-secondary"
        >
          ä¸‹ä¸€é¡µ
        </button>
      </div>
    </div>

    <div v-else class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <h3>æ²¡æœ‰æ‰¾åˆ°æ¼æ´</h3>
      <p v-if="!selectedProject">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®</p>
      <p v-else>å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ¼æ´æ•°æ®</p>
    </div>

    <!-- æ¼æ´è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div v-if="selectedVuln" class="modal-overlay" @click="closeVulnDetail">
      <div class="modal large" @click.stop>
        <div class="modal-header">
          <h2>æ¼æ´è¯¦æƒ…</h2>
          <button @click="closeVulnDetail" class="btn-close">Ã—</button>
        </div>
        <div class="modal-content">
          <div class="vuln-detail">
            <div class="detail-section">
              <h3>åŸºæœ¬ä¿¡æ¯</h3>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>æ¼æ´æ ‡é¢˜:</label>
                  <span>{{ selectedVuln.title }}</span>
                </div>
                <div class="detail-item" v-if="selectedVuln.cve_id">
                  <label>CVEç¼–å·:</label>
                  <span>{{ selectedVuln.cve_id }}</span>
                </div>
                <div class="detail-item">
                  <label>ä¸¥é‡ç¨‹åº¦:</label>
                  <span class="severity-badge" :class="selectedVuln.severity">
                    {{ getSeverityLabel(selectedVuln.severity) }}
                  </span>
                </div>
                <div class="detail-item">
                  <label>CVSSåˆ†æ•°:</label>
                  <span class="cvss-score" :class="getCvssClass(selectedVuln.cvss)">
                    {{ selectedVuln.cvss || 'N/A' }}
                  </span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h3>ä½ç½®ä¿¡æ¯</h3>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>ä½ç½®:</label>
                  <span>{{ selectedVuln.location }}</span>
                </div>
                <div class="detail-item" v-if="selectedVuln.parameter">
                  <label>å‚æ•°:</label>
                  <span class="code">{{ selectedVuln.parameter }}</span>
                </div>
              </div>
            </div>

            <div class="detail-section" v-if="selectedVuln.description">
              <h3>æ¼æ´æè¿°</h3>
              <div class="description">
                {{ selectedVuln.description }}
              </div>
            </div>

            <div class="detail-section" v-if="selectedVuln.payload">
              <h3>æµ‹è¯•è½½è·</h3>
              <div class="payload">
                <pre><code>{{ selectedVuln.payload }}</code></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { scanApi } from '@/api/scanApi'

export default {
  name: 'VulnerabilityList',
  data() {
    return {
      projects: [],
      selectedProject: '',
      vulnerabilities: [],
      filteredVulnerabilities: [],
      loading: false,
      filters: {
        severity: [],
        status: '',
        search: ''
      },
      stats: {},
      selectedVuln: null,
      currentPage: 1,
      pageSize: 20
    }
  },
  computed: {
    paginatedVulnerabilities() {
      const start = (this.currentPage - 1) * this.pageSize
      const end = start + this.pageSize
      return this.filteredVulnerabilities.slice(start, end)
    },
    totalPages() {
      return Math.ceil(this.filteredVulnerabilities.length / this.pageSize)
    }
  },
  async mounted() {
    await this.loadProjects()
    // å¦‚æœURLä¸­æœ‰é¡¹ç›®IDï¼Œè‡ªåŠ¨é€‰æ‹©è¯¥é¡¹ç›®
    if (this.$route.params.projectId) {
      this.selectedProject = this.$route.params.projectId
      await this.loadVulnerabilities()
    }
  },
  methods: {
    async loadProjects() {
      try {
        const response = await scanApi.getProjects()
        this.projects = response.data.data
      } catch (error) {
        console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error)
        this.$toast.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥')
      }
    },

    async loadVulnerabilities() {
      if (!this.selectedProject) {
        this.vulnerabilities = []
        this.filteredVulnerabilities = []
        this.stats = {}
        return
      }

      try {
        this.loading = true
        const response = await scanApi.getVulnerabilities(this.selectedProject)
        this.vulnerabilities = response.data.data
        this.calculateStats()
        this.applyFilters()
      } catch (error) {
        console.error('åŠ è½½æ¼æ´æ•°æ®å¤±è´¥:', error)
        this.$toast.error('åŠ è½½æ¼æ´æ•°æ®å¤±è´¥')
      } finally {
        this.loading = false
      }
    },

    calculateStats() {
      this.stats = this.vulnerabilities.reduce((acc, vuln) => {
        acc[vuln.severity] = (acc[vuln.severity] || 0) + 1
        return acc
      }, {})
    },

    applyFilters() {
      let filtered = [...this.vulnerabilities]

      // ä¸¥é‡ç¨‹åº¦ç­›é€‰
      if (this.filters.severity.length > 0) {
        filtered = filtered.filter(vuln => this.filters.severity.includes(vuln.severity))
      }

      // çŠ¶æ€ç­›é€‰
      if (this.filters.status) {
        filtered = filtered.filter(vuln => vuln.status === this.filters.status)
      }

      // æœç´¢ç­›é€‰
      if (this.filters.search) {
        const search = this.filters.search.toLowerCase()
        filtered = filtered.filter(vuln =>
          vuln.title.toLowerCase().includes(search) ||
          (vuln.cve_id && vuln.cve_id.toLowerCase().includes(search)) ||
          vuln.location.toLowerCase().includes(search) ||
          (vuln.description && vuln.description.toLowerCase().includes(search))
        )
      }

      this.filteredVulnerabilities = filtered
      this.currentPage = 1
    },

    async updateVulnStatus(vuln) {
      try {
        await scanApi.updateVulnerabilityStatus(this.selectedProject, vuln.id, vuln.status)
        this.$toast.success('çŠ¶æ€å·²æ›´æ–°')
        this.calculateStats()
      } catch (error) {
        console.error('æ›´æ–°æ¼æ´çŠ¶æ€å¤±è´¥:', error)
        this.$toast.error('æ›´æ–°æ¼æ´çŠ¶æ€å¤±è´¥')
        // æ¢å¤åŸçŠ¶æ€
        await this.loadVulnerabilities()
      }
    },

    viewVulnerability(vuln) {
      this.selectedVuln = vuln
    },

    closeVulnDetail() {
      this.selectedVuln = null
    },

    async exportVulnerabilities() {
      try {
        const response = await scanApi.exportProject(this.selectedProject, 'excel')
        const blob = new Blob([response.data], {
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        })
        const url = window.URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = `vulnerabilities-${this.selectedProject}-${new Date().toISOString().split('T')[0]}.xlsx`
        link.click()
        window.URL.revokeObjectURL(url)
        this.$toast.success('æŠ¥å‘Šå·²å¯¼å‡º')
      } catch (error) {
        console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', error)
        this.$toast.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥')
      }
    },

    copyLocation(vuln) {
      navigator.clipboard.writeText(vuln.location).then(() => {
        this.$toast.success('ä½ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
      })
    },

    getSeverityLabel(severity) {
      const labels = {
        critical: 'ä¸¥é‡',
        high: 'é«˜å±',
        medium: 'ä¸­å±',
        low: 'ä½å±',
        info: 'ä¿¡æ¯'
      }
      return labels[severity] || severity
    },

    getCvssClass(cvss) {
      if (!cvss) return ''
      if (cvss >= 9.0) return 'critical'
      if (cvss >= 7.0) return 'high'
      if (cvss >= 4.0) return 'medium'
      if (cvss >= 0.1) return 'low'
      return 'info'
    },

    formatDate(timestamp) {
      return new Date(timestamp * 1000).toLocaleDateString('zh-CN')
    },

    prevPage() {
      if (this.currentPage > 1) {
        this.currentPage--
      }
    },

    nextPage() {
      if (this.currentPage < this.totalPages) {
        this.currentPage++
      }
    }
  }
}
</script>

<style scoped>
.vulnerability-list {
  padding: 24px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.page-header h1 {
  margin: 0;
  color: #1a1a1a;
  font-size: 28px;
  font-weight: 600;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.project-select {
  padding: 8px 12px;
  border: 1px solid #e1e5e9;
  border-radius: 6px;
  font-size: 14px;
  min-width: 200px;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 24px;
  padding: 20px;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 12px;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-group label {
  font-weight: 500;
  color: #374151;
  white-space: nowrap;
}

.severity-filters {
  display: flex;
  gap: 12px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
  margin: 0;
}

.severity-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.severity-badge.critical {
  background: #fee2e2;
  color: #dc2626;
}

.severity-badge.high {
  background: #fed7aa;
  color: #ea580c;
}

.severity-badge.medium {
  background: #fef3c7;
  color: #d97706;
}

.severity-badge.low {
  background: #dcfce7;
  color: #16a34a;
}

.severity-badge.info {
  background: #dbeafe;
  color: #2563eb;
}

.status-select {
  padding: 6px 10px;
  border: 1px solid #e1e5e9;
  border-radius: 4px;
  font-size: 14px;
}

.status-select.inline {
  padding: 4px 8px;
  font-size: 12px;
}

.status-select.open {
  color: #dc2626;
}

.status-select.fixed {
  color: #16a34a;
}

.status-select.false_positive {
  color: #6b7280;
}

.search-input {
  padding: 8px 12px;
  border: 1px solid #e1e5e9;
  border-radius: 6px;
  font-size: 14px;
  min-width: 250px;
}

.vulnerability-stats {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  flex: 1;
  text-align: center;
  padding: 16px;
  border-radius: 8px;
  border: 2px solid;
}

.stat-card.critical {
  background: #fef2f2;
  border-color: #dc2626;
}

.stat-card.high {
  background: #fef3ec;
  border-color: #ea580c;
}

.stat-card.medium {
  background: #fffbeb;
  border-color: #d97706;
}

.stat-card.low {
  background: #f0fdf4;
  border-color: #16a34a;
}

.stat-card.info {
  background: #f0f9ff;
  border-color: #0284c7;
}

.stat-count {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 14px;
  font-weight: 500;
}

.vulnerability-table {
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 12px;
  overflow: hidden;
}

.vulnerability-table table {
  width: 100%;
  border-collapse: collapse;
}

.vulnerability-table th {
  background: #f9fafb;
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: #374151;
  border-bottom: 1px solid #e1e5e9;
}

.vulnerability-table td {
  padding: 12px 16px;
  border-bottom: 1px solid #f3f4f6;
}

.vuln-row:hover {
  background: #f9fafb;
}

.vuln-title {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.title {
  font-weight: 500;
  color: #1a1a1a;
}

.cve-id {
  font-size: 12px;
  color: #6b7280;
  font-family: monospace;
}

.cvss-score {
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
}

.cvss-score.critical {
  background: #fee2e2;
  color: #dc2626;
}

.cvss-score.high {
  background: #fed7aa;
  color: #ea580c;
}

.cvss-score.medium {
  background: #fef3c7;
  color: #d97706;
}

.cvss-score.low {
  background: #dcfce7;
  color: #16a34a;
}

.location {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.location-text {
  font-family: monospace;
  font-size: 13px;
  color: #1a1a1a;
}

.parameter {
  font-family: monospace;
  font-size: 11px;
  color: #6b7280;
}

.date {
  color: #6b7280;
  font-size: 14px;
}

.actions {
  display: flex;
  gap: 8px;
}

.btn-icon {
  background: none;
  border: none;
  padding: 4px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-icon:hover {
  background: #f3f4f6;
}

.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: #f9fafb;
  border-top: 1px solid #e1e5e9;
}

.page-info {
  color: #6b7280;
  font-size: 14px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.empty-state h3 {
  color: #1a1a1a;
  margin-bottom: 8px;
}

.empty-state p {
  color: #6b7280;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal.large {
  max-width: 1000px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #e1e5e9;
}

.modal-content {
  padding: 24px;
}

.detail-section {
  margin-bottom: 24px;
}

.detail-section h3 {
  margin: 0 0 16px 0;
  color: #1a1a1a;
  font-size: 18px;
  font-weight: 600;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.detail-item label {
  font-weight: 500;
  color: #374151;
  font-size: 14px;
}

.detail-item span {
  color: #1a1a1a;
}

.code {
  font-family: monospace;
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 13px;
}

.description {
  color: #374151;
  line-height: 1.6;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
}

.payload {
  background: #1f2937;
  color: #f9fafb;
  border-radius: 8px;
  overflow-x: auto;
}

.payload pre {
  margin: 0;
  padding: 16px;
  font-size: 13px;
  font-family: monospace;
}

.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f4f6;
  border-top: 4px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  background: #f3f4f6;
  color: #374151;
}

.btn-secondary:hover:not(:disabled) {
  background: #e5e7eb;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6b7280;
}

.icon {
  font-style: normal;
}
</style>